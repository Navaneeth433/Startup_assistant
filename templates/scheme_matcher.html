<!-- templates/scheme_matcher.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Startup Scheme Matcher</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f6f7fb; }
    .container { max-width: 720px; margin: 20px auto; }
    .card {
      background: #fff;
      padding: 22px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    .schemes-title {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .criteria {
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
    }
    .scheme {
      background: #fff;
      padding: 14px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.04);
    }
    .scheme a { color: #2563eb; text-decoration: none; }
    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align:center">Personalized Scheme Matching</h1>

    <div id="status" class="card">
      Loading your matching schemesâ€¦
    </div>

    <div id="results"></div>
  </div>

  <script>
    async function loadSchemesForCurrentUser() {
      const statusDiv = document.getElementById("status");
      const resultsDiv = document.getElementById("results");

      try {
        const res = await fetch("/api/match/auto", {
          method: "GET",
          credentials: "include"    // ensure session cookie is sent
        });

        if (res.status === 401) {
          statusDiv.innerHTML = "You are not logged in. Please log in to see personalized schemes.";
          return;
        }

        if (res.status === 404) {
          statusDiv.innerHTML = "No startup profile found. Please complete signup / profile first.";
          return;
        }

        if (!res.ok) {
          statusDiv.innerHTML = "Something went wrong while fetching schemes.";
          return;
        }

        const data = await res.json();
        const criteria = data.criteria || {};
        const schemes = data.results || [];

        statusDiv.innerHTML = `
          <div class="schemes-title"><strong>Matched schemes based on your startup profile:</strong></div>
          <div class="criteria">
            <span class="badge">Domain: ${criteria.domain || "N/A"}</span>
            <span class="badge">Registration: ${criteria.registration || "N/A"}</span>
            <span class="badge">Stage: ${criteria.stage || "N/A"}</span>
          </div>
        `;

        resultsDiv.innerHTML = "";

        if (!Array.isArray(schemes) || schemes.length === 0) {
          resultsDiv.innerHTML = "<p>No matching schemes found for your current profile.</p>";
          return;
        }

        schemes.forEach(scheme => {
          const div = document.createElement("div");
          div.className = "scheme";
          const benefits = Array.isArray(scheme.benefits)
            ? scheme.benefits.join(", ")
            : (scheme.benefits || "N/A");

          div.innerHTML = `
            <h3>${scheme.name}</h3>
            <p><strong>Benefits:</strong> ${benefits}</p>
            <p><a href="${scheme.link}" target="_blank" rel="noopener noreferrer">Apply / Read More</a></p>
          `;
          resultsDiv.appendChild(div);
        });

      } catch (err) {
        console.error("Error loading schemes:", err);
        statusDiv.innerHTML = "Failed to load schemes. Please try again later.";
      }
    }

    // Load on page open
    loadSchemesForCurrentUser();
  </script>
</body>
</html>
